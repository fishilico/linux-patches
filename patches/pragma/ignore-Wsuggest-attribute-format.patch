From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Nicolas Iooss <nicolas.iooss_linux@m4x.org>
Date: Sat, 4 Jul 2015 11:50:02 +0800
Subject: [PATCH] {PRAGMA} ignore -Wsuggest-attribute=format

---
 drivers/infiniband/hw/hfi1/trace_dbg.h               |  4 ++++
 .../broadcom/brcm80211/brcmfmac/tracepoint.h         |  8 ++++++++
 .../brcm80211/brcmsmac/brcms_trace_brcmsmac_msg.h    |  8 ++++++++
 .../net/wireless/intel/iwlwifi/iwl-devtrace-msg.h    |  8 ++++++++
 include/linux/compiler-gcc.h                         |  2 ++
 include/trace/events/qla.h                           |  1 -
 kernel/bpf/helpers.c                                 |  4 ++++
 kernel/panic.c                                       |  4 ++++
 kernel/trace/bpf_trace.c                             | 12 ++++++++++++
 kernel/trace/trace.c                                 |  7 +++++++
 lib/vsprintf.c                                       |  4 ++++
 samples/trace_events/trace-events-sample.h           |  4 ++++
 12 files changed, 65 insertions(+), 1 deletion(-)

diff --git a/drivers/infiniband/hw/hfi1/trace_dbg.h b/drivers/infiniband/hw/hfi1/trace_dbg.h
index 582b6f68df3d..215534d30bdd 100644
--- a/drivers/infiniband/hw/hfi1/trace_dbg.h
+++ b/drivers/infiniband/hw/hfi1/trace_dbg.h
@@ -22,6 +22,9 @@
 
 #define MAX_MSG_LEN 512
 
+__diag_push()
+__diag_ignore(GCC, 4, "-Wsuggest-attribute=format",
+	      "This function uses a va_format, which is impossible to declare in __printf")
 DECLARE_EVENT_CLASS(hfi1_trace_template,
 		    TP_PROTO(const char *function, struct va_format *vaf),
 		    TP_ARGS(function, vaf),
@@ -35,6 +38,7 @@ DECLARE_EVENT_CLASS(hfi1_trace_template,
 			      __get_str(function),
 			      __get_str(msg))
 );
+__diag_pop()
 
 /*
  * It may be nice to macroize the __hfi1_trace but the va_* stuff requires an
diff --git a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/tracepoint.h b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/tracepoint.h
index 5a139d7ed47a..5b8e149fe291 100644
--- a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/tracepoint.h
+++ b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/tracepoint.h
@@ -28,6 +28,9 @@ static inline void trace_ ## name(proto) {}
 
 #define MAX_MSG_LEN		100
 
+__diag_push()
+__diag_ignore(GCC, 4, "-Wsuggest-attribute=format",
+	      "This function uses a va_format, which is impossible to declare in __printf")
 TRACE_EVENT(brcmf_err,
 	TP_PROTO(const char *func, struct va_format *vaf),
 	TP_ARGS(func, vaf),
@@ -41,7 +44,11 @@ TRACE_EVENT(brcmf_err,
 	),
 	TP_printk("%s: %s", __get_str(func), __get_str(msg))
 );
+__diag_pop()
 
+__diag_push()
+__diag_ignore(GCC, 4, "-Wsuggest-attribute=format",
+	      "This function uses a va_format, which is impossible to declare in __printf")
 TRACE_EVENT(brcmf_dbg,
 	TP_PROTO(u32 level, const char *func, struct va_format *vaf),
 	TP_ARGS(level, func, vaf),
@@ -57,6 +64,7 @@ TRACE_EVENT(brcmf_dbg,
 	),
 	TP_printk("%s: %s", __get_str(func), __get_str(msg))
 );
+__diag_pop()
 
 TRACE_EVENT(brcmf_hexdump,
 	TP_PROTO(void *data, size_t len),
diff --git a/drivers/net/wireless/broadcom/brcm80211/brcmsmac/brcms_trace_brcmsmac_msg.h b/drivers/net/wireless/broadcom/brcm80211/brcmsmac/brcms_trace_brcmsmac_msg.h
index 488456420353..b634dab837db 100644
--- a/drivers/net/wireless/broadcom/brcm80211/brcmsmac/brcms_trace_brcmsmac_msg.h
+++ b/drivers/net/wireless/broadcom/brcm80211/brcmsmac/brcms_trace_brcmsmac_msg.h
@@ -24,6 +24,9 @@
 
 #define MAX_MSG_LEN	100
 
+__diag_push()
+__diag_ignore(GCC, 4, "-Wsuggest-attribute=format",
+	      "This function uses a va_format, which is impossible to declare in __printf")
 DECLARE_EVENT_CLASS(brcms_msg_event,
 	TP_PROTO(struct va_format *vaf),
 	TP_ARGS(vaf),
@@ -35,6 +38,7 @@ DECLARE_EVENT_CLASS(brcms_msg_event,
 	),
 	TP_printk("%s", __get_str(msg))
 );
+__diag_pop()
 
 DEFINE_EVENT(brcms_msg_event, brcms_info,
 	TP_PROTO(struct va_format *vaf),
@@ -56,6 +60,9 @@ DEFINE_EVENT(brcms_msg_event, brcms_crit,
 	TP_ARGS(vaf)
 );
 
+__diag_push()
+__diag_ignore(GCC, 4, "-Wsuggest-attribute=format",
+	      "This function uses a va_format, which is impossible to declare in __printf")
 TRACE_EVENT(brcms_dbg,
 	TP_PROTO(u32 level, const char *func, struct va_format *vaf),
 	TP_ARGS(level, func, vaf),
@@ -71,6 +78,7 @@ TRACE_EVENT(brcms_dbg,
 	),
 	TP_printk("%s: %s", __get_str(func), __get_str(msg))
 );
+__diag_pop()
 #endif /* __TRACE_BRCMSMAC_MSG_H */
 
 #ifdef CONFIG_BRCM_TRACING
diff --git a/drivers/net/wireless/intel/iwlwifi/iwl-devtrace-msg.h b/drivers/net/wireless/intel/iwlwifi/iwl-devtrace-msg.h
index 1d6c292cf545..5cfea6cc466c 100644
--- a/drivers/net/wireless/intel/iwlwifi/iwl-devtrace-msg.h
+++ b/drivers/net/wireless/intel/iwlwifi/iwl-devtrace-msg.h
@@ -14,6 +14,9 @@
 
 #define MAX_MSG_LEN	110
 
+__diag_push()
+__diag_ignore(GCC, 4, "-Wsuggest-attribute=format",
+	      "This function uses a va_format, which is impossible to declare in __printf")
 DECLARE_EVENT_CLASS(iwlwifi_msg_event,
 	TP_PROTO(struct va_format *vaf),
 	TP_ARGS(vaf),
@@ -25,6 +28,7 @@ DECLARE_EVENT_CLASS(iwlwifi_msg_event,
 	),
 	TP_printk("%s", __get_str(msg))
 );
+__diag_pop()
 
 DEFINE_EVENT(iwlwifi_msg_event, iwlwifi_err,
 	TP_PROTO(struct va_format *vaf),
@@ -46,6 +50,9 @@ DEFINE_EVENT(iwlwifi_msg_event, iwlwifi_crit,
 	TP_ARGS(vaf)
 );
 
+__diag_push()
+__diag_ignore(GCC, 4, "-Wsuggest-attribute=format",
+	      "This function uses a va_format, which is impossible to declare in __printf")
 TRACE_EVENT(iwlwifi_dbg,
 	TP_PROTO(u32 level, const char *function,
 		 struct va_format *vaf),
@@ -62,6 +69,7 @@ TRACE_EVENT(iwlwifi_dbg,
 	),
 	TP_printk("%s", __get_str(msg))
 );
+__diag_pop()
 #endif /* __IWLWIFI_DEVICE_TRACE_MSG */
 
 #undef TRACE_INCLUDE_PATH
diff --git a/include/linux/compiler-gcc.h b/include/linux/compiler-gcc.h
index f55a37efdb97..f3e35911f901 100644
--- a/include/linux/compiler-gcc.h
+++ b/include/linux/compiler-gcc.h
@@ -136,6 +136,8 @@
 #define __diag_str(s)		__diag_str1(s)
 #define __diag(s)		_Pragma(__diag_str(GCC diagnostic s))
 
+#define __diag_GCC_4(s)		__diag(s)
+
 #if GCC_VERSION >= 80000
 #define __diag_GCC_8(s)		__diag(s)
 #else
diff --git a/include/trace/events/qla.h b/include/trace/events/qla.h
index e7fd55e7dc3d..de05cd5d5dc7 100644
--- a/include/trace/events/qla.h
+++ b/include/trace/events/qla.h
@@ -31,7 +31,6 @@ DECLARE_EVENT_CLASS(qla_log_event,
 
 	TP_printk("%s %s", __get_str(buf), __get_str(msg))
 );
-
 #pragma GCC diagnostic pop
 
 DEFINE_EVENT(qla_log_event, ql_dbg_log,
diff --git a/kernel/bpf/helpers.c b/kernel/bpf/helpers.c
index a6b04faed282..de320e8e8b89 100644
--- a/kernel/bpf/helpers.c
+++ b/kernel/bpf/helpers.c
@@ -1037,7 +1037,11 @@ BPF_CALL_5(bpf_snprintf, char *, str, u32, str_size, char *, fmt,
 	if (err < 0)
 		return err;
 
+	__diag_push()
+	__diag_ignore(GCC, 4, "-Wsuggest-attribute=format",
+		      "This function is never called directly")
 	err = bstr_printf(str, str_size, fmt, bin_args);
+	__diag_pop()
 
 	bpf_bprintf_cleanup();
 
diff --git a/kernel/panic.c b/kernel/panic.c
index da323209f583..b52491dcfe2d 100644
--- a/kernel/panic.c
+++ b/kernel/panic.c
@@ -609,8 +609,12 @@ void __warn(const char *file, int line, void *caller, unsigned taint,
 		pr_warn("WARNING: CPU: %d PID: %d at %pS\n",
 			raw_smp_processor_id(), current->pid, caller);
 
+	__diag_push()
+	__diag_ignore(GCC, 4, "-Wsuggest-attribute=format",
+		"It is not possible to add __printf attribute to this function")
 	if (args)
 		vprintk(args->fmt, args->args);
+	__diag_pop()
 
 	print_modules();
 
diff --git a/kernel/trace/bpf_trace.c b/kernel/trace/bpf_trace.c
index 1ed08967fb97..b6db8a44042f 100644
--- a/kernel/trace/bpf_trace.c
+++ b/kernel/trace/bpf_trace.c
@@ -388,7 +388,11 @@ BPF_CALL_5(bpf_trace_printk, char *, fmt, u32, fmt_size, u64, arg1,
 		return ret;
 
 	raw_spin_lock_irqsave(&trace_printk_lock, flags);
+	__diag_push()
+	__diag_ignore(GCC, 4, "-Wsuggest-attribute=format",
+		      "This function does not behave like printf even though it calls bstr_printf")
 	ret = bstr_printf(buf, sizeof(buf), fmt, bin_args);
+	__diag_pop()
 
 	trace_bpf_trace_printk(buf);
 	raw_spin_unlock_irqrestore(&trace_printk_lock, flags);
@@ -426,6 +430,9 @@ const struct bpf_func_proto *bpf_get_trace_printk_proto(void)
 	return &bpf_trace_printk_proto;
 }
 
+__diag_push()
+__diag_ignore(GCC, 4, "-Wsuggest-attribute=format",
+	"It is not possible to add __printf attribute to this function")
 BPF_CALL_4(bpf_trace_vprintk, char *, fmt, u32, fmt_size, const void *, data,
 	   u32, data_len)
 {
@@ -453,6 +460,7 @@ BPF_CALL_4(bpf_trace_vprintk, char *, fmt, u32, fmt_size, const void *, data,
 
 	return ret;
 }
+__diag_pop()
 
 static const struct bpf_func_proto bpf_trace_vprintk_proto = {
 	.func		= bpf_trace_vprintk,
@@ -485,7 +493,11 @@ BPF_CALL_5(bpf_seq_printf, struct seq_file *, m, char *, fmt, u32, fmt_size,
 	if (err < 0)
 		return err;
 
+	__diag_push()
+	__diag_ignore(GCC, 4, "-Wsuggest-attribute=format",
+		      "This function does not behave like printf even though it calls seq_bprintf")
 	seq_bprintf(m, fmt, bin_args);
+	__diag_pop()
 
 	bpf_bprintf_cleanup();
 
diff --git a/kernel/trace/trace.c b/kernel/trace/trace.c
index 47a44b055a1d..1d681391ac0e 100644
--- a/kernel/trace/trace.c
+++ b/kernel/trace/trace.c
@@ -3795,6 +3795,10 @@ static void test_can_verify(void)
  * warn and print "[UNSAFE MEMORY]" in place of the dereferenced string
  * pointer.
  */
+#ifndef __clang__
+__diag_push()
+__diag(ignored "-Wsuggest-attribute=format")
+#endif
 void trace_check_vprintf(struct trace_iterator *iter, const char *fmt,
 			 va_list ap)
 {
@@ -3927,6 +3931,9 @@ void trace_check_vprintf(struct trace_iterator *iter, const char *fmt,
 	if (*p)
 		trace_seq_vprintf(&iter->seq, p, ap);
 }
+#ifndef __clang__
+__diag_pop()
+#endif
 
 const char *trace_event_format(struct trace_iterator *iter, const char *fmt)
 {
diff --git a/lib/vsprintf.c b/lib/vsprintf.c
index b82375f7c6fd..f67b873d799f 100644
--- a/lib/vsprintf.c
+++ b/lib/vsprintf.c
@@ -1682,7 +1682,11 @@ static char *va_format(char *buf, char *end, struct va_format *va_fmt,
 		return buf;
 
 	va_copy(va, *va_fmt->va);
+	__diag_push()
+	__diag_ignore(GCC, 4, "-Wsuggest-attribute=format",
+		      "It is not possible to add __printf attribute to this function")
 	buf += vsnprintf(buf, end > buf ? end - buf : 0, va_fmt->fmt, va);
+	__diag_pop()
 	va_end(va);
 
 	return buf;
diff --git a/samples/trace_events/trace-events-sample.h b/samples/trace_events/trace-events-sample.h
index 1a92226202fc..b84aae47bd94 100644
--- a/samples/trace_events/trace-events-sample.h
+++ b/samples/trace_events/trace-events-sample.h
@@ -274,6 +274,9 @@ TRACE_DEFINE_ENUM(TRACE_SAMPLE_FOO);
 TRACE_DEFINE_ENUM(TRACE_SAMPLE_BAR);
 TRACE_DEFINE_ENUM(TRACE_SAMPLE_ZOO);
 
+__diag_push()
+__diag_ignore(GCC, 4, "-Wsuggest-attribute=format",
+	      "It is not possible to add __printf attribute to this function")
 TRACE_EVENT(foo_bar,
 
 	TP_PROTO(const char *foo, int bar, const int *lst,
@@ -347,6 +350,7 @@ TRACE_EVENT(foo_bar,
 				sizeof(int)),
 		  __get_str(str), __get_bitmask(cpus), __get_str(vstr))
 );
+__diag_pop()
 
 /*
  * There may be a case where a tracepoint should only be called if
-- 
