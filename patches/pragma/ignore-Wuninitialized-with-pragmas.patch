From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Nicolas Iooss <nicolas.iooss_linux@m4x.org>
Date: Sat, 21 Mar 2015 15:59:39 +0800
Subject: [PATCH] {PRAGMA} ignore -Wuninitialized with pragmas

---
 drivers/block/drbd/drbd_receiver.c                       | 3 +++
 drivers/media/platform/soc_camera/sh_mobile_ceu_camera.c | 3 +++
 drivers/net/wimax/i2400m/driver.c                        | 3 +++
 fs/crypto/fscrypt_private.h                              | 9 +++++++++
 include/linux/ceph/osdmap.h                              | 9 +++++++++
 include/linux/completion.h                               | 8 ++++++++
 include/linux/kthread.h                                  | 8 ++++++++
 include/linux/wait.h                                     | 8 ++++++++
 kernel/kthread.c                                         | 6 ++++++
 kernel/smp.c                                             | 3 +++
 kernel/workqueue.c                                       | 3 +++
 11 files changed, 63 insertions(+)

diff --git a/drivers/block/drbd/drbd_receiver.c b/drivers/block/drbd/drbd_receiver.c
index c7e95e6380fb..2a90dbc093d6 100644
--- a/drivers/block/drbd/drbd_receiver.c
+++ b/drivers/block/drbd/drbd_receiver.c
@@ -937,10 +937,13 @@ static int conn_connect(struct drbd_connection *connection)
 	int vnr, timeout, h;
 	bool discard_my_data, ok;
 	enum drbd_state_rv rv;
+#pragma GCC diagnostic push
+#pragma GCC diagnostic ignored "-Wuninitialized"
 	struct accept_wait_data ad = {
 		.connection = connection,
 		.door_bell = COMPLETION_INITIALIZER_ONSTACK(ad.door_bell),
 	};
+#pragma GCC diagnostic pop
 
 	clear_bit(DISCONNECT_SENT, &connection->flags);
 	if (conn_request_state(connection, NS(conn, C_WF_CONNECTION), CS_VERBOSE) < SS_SUCCESS)
diff --git a/drivers/media/platform/soc_camera/sh_mobile_ceu_camera.c b/drivers/media/platform/soc_camera/sh_mobile_ceu_camera.c
index 96dc01750bc0..47d0b281341e 100644
--- a/drivers/media/platform/soc_camera/sh_mobile_ceu_camera.c
+++ b/drivers/media/platform/soc_camera/sh_mobile_ceu_camera.c
@@ -1640,10 +1640,13 @@ static int sh_mobile_ceu_probe(struct platform_device *pdev)
 	void __iomem *base;
 	unsigned int irq;
 	int err;
+#pragma GCC diagnostic push
+#pragma GCC diagnostic ignored "-Wuninitialized"
 	struct bus_wait wait = {
 		.completion = COMPLETION_INITIALIZER_ONSTACK(wait.completion),
 		.notifier.notifier_call = bus_notify,
 	};
+#pragma GCC diagnostic pop
 
 	res = platform_get_resource(pdev, IORESOURCE_MEM, 0);
 	irq = platform_get_irq(pdev, 0);
diff --git a/drivers/net/wimax/i2400m/driver.c b/drivers/net/wimax/i2400m/driver.c
index 9c78090e72f8..2b7c3e22b7bb 100644
--- a/drivers/net/wimax/i2400m/driver.c
+++ b/drivers/net/wimax/i2400m/driver.c
@@ -180,10 +180,13 @@ int i2400m_op_reset(struct wimax_dev *wimax_dev)
 	int result;
 	struct i2400m *i2400m = wimax_dev_to_i2400m(wimax_dev);
 	struct device *dev = i2400m_dev(i2400m);
+#pragma GCC diagnostic push
+#pragma GCC diagnostic ignored "-Wuninitialized"
 	struct i2400m_reset_ctx ctx = {
 		.completion = COMPLETION_INITIALIZER_ONSTACK(ctx.completion),
 		.result = 0,
 	};
+#pragma GCC diagnostic pop
 
 	d_fnstart(4, dev, "(wimax_dev %p)\n", wimax_dev);
 	mutex_lock(&i2400m->init_mutex);
diff --git a/fs/crypto/fscrypt_private.h b/fs/crypto/fscrypt_private.h
index a1d5021c31ef..d5572e3fff82 100644
--- a/fs/crypto/fscrypt_private.h
+++ b/fs/crypto/fscrypt_private.h
@@ -74,9 +74,18 @@ struct fscrypt_completion_result {
 	int res;
 };
 
+#ifdef __clang__
 #define DECLARE_FS_COMPLETION_RESULT(ecr) \
+_Pragma("GCC diagnostic push") \
+_Pragma("GCC diagnostic ignored \"-Wuninitialized\"") \
 	struct fscrypt_completion_result ecr = { \
 		COMPLETION_INITIALIZER_ONSTACK((ecr).completion), 0 }
+_Pragma("GCC diagnostic pop")
+#else
+#define DECLARE_FS_COMPLETION_RESULT(ecr) \
+	struct fscrypt_completion_result ecr = { \
+		COMPLETION_INITIALIZER_ONSTACK((ecr).completion), 0 }
+#endif
 
 
 /* crypto.c */
diff --git a/include/linux/ceph/osdmap.h b/include/linux/ceph/osdmap.h
index a0996cb9faed..67a0859f773e 100644
--- a/include/linux/ceph/osdmap.h
+++ b/include/linux/ceph/osdmap.h
@@ -118,8 +118,17 @@ static inline void ceph_oid_init(struct ceph_object_id *oid)
 
 #define CEPH_OID_INIT_ONSTACK(oid)					\
     ({ ceph_oid_init(&oid); oid; })
+/* clang does not like struct ceph_object_id oid = ({ ...; oid;}); */
+#ifdef __clang__
+#define CEPH_DEFINE_OID_ONSTACK(oid)					\
+_Pragma("GCC diagnostic push") \
+_Pragma("GCC diagnostic ignored \"-Wuninitialized\"") \
+	struct ceph_object_id oid = CEPH_OID_INIT_ONSTACK(oid) \
+_Pragma("GCC diagnostic pop")
+#else
 #define CEPH_DEFINE_OID_ONSTACK(oid)					\
 	struct ceph_object_id oid = CEPH_OID_INIT_ONSTACK(oid)
+#endif
 
 static inline bool ceph_oid_empty(const struct ceph_object_id *oid)
 {
diff --git a/include/linux/completion.h b/include/linux/completion.h
index 5d5aaae3af43..507390320013 100644
--- a/include/linux/completion.h
+++ b/include/linux/completion.h
@@ -57,8 +57,16 @@ struct completion {
  * stack.
  */
 #ifdef CONFIG_LOCKDEP
+#ifdef __clang__
+# define DECLARE_COMPLETION_ONSTACK(work) \
+_Pragma("GCC diagnostic push") \
+_Pragma("GCC diagnostic ignored \"-Wuninitialized\"") \
+	struct completion work = COMPLETION_INITIALIZER_ONSTACK(work) \
+_Pragma("GCC diagnostic pop")
+#else
 # define DECLARE_COMPLETION_ONSTACK(work) \
 	struct completion work = COMPLETION_INITIALIZER_ONSTACK(work)
+#endif
 #else
 # define DECLARE_COMPLETION_ONSTACK(work) DECLARE_COMPLETION(work)
 #endif
diff --git a/include/linux/kthread.h b/include/linux/kthread.h
index 4fec8b775895..0c4d2324b021 100644
--- a/include/linux/kthread.h
+++ b/include/linux/kthread.h
@@ -138,8 +138,16 @@ struct kthread_delayed_work {
 #ifdef CONFIG_LOCKDEP
 # define KTHREAD_WORKER_INIT_ONSTACK(worker)				\
 	({ kthread_init_worker(&worker); worker; })
+#ifdef __clang__
+# define DEFINE_KTHREAD_WORKER_ONSTACK(worker)				\
+_Pragma("GCC diagnostic push") \
+_Pragma("GCC diagnostic ignored \"-Wuninitialized\"") \
+	struct kthread_worker worker = KTHREAD_WORKER_INIT_ONSTACK(worker) \
+_Pragma("GCC diagnostic pop")
+#else
 # define DEFINE_KTHREAD_WORKER_ONSTACK(worker)				\
 	struct kthread_worker worker = KTHREAD_WORKER_INIT_ONSTACK(worker)
+#endif
 #else
 # define DEFINE_KTHREAD_WORKER_ONSTACK(worker) DEFINE_KTHREAD_WORKER(worker)
 #endif
diff --git a/include/linux/wait.h b/include/linux/wait.h
index 5b74e36c0ca8..2696b79071e0 100644
--- a/include/linux/wait.h
+++ b/include/linux/wait.h
@@ -68,8 +68,16 @@ extern void __init_waitqueue_head(struct wait_queue_head *wq_head, const char *n
 #ifdef CONFIG_LOCKDEP
 # define __WAIT_QUEUE_HEAD_INIT_ONSTACK(name) \
 	({ init_waitqueue_head(&name); name; })
+#ifdef __clang__
+# define DECLARE_WAIT_QUEUE_HEAD_ONSTACK(name) \
+_Pragma("GCC diagnostic push") \
+_Pragma("GCC diagnostic ignored \"-Wuninitialized\"") \
+	struct wait_queue_head name = __WAIT_QUEUE_HEAD_INIT_ONSTACK(name) \
+_Pragma("GCC diagnostic pop")
+#else
 # define DECLARE_WAIT_QUEUE_HEAD_ONSTACK(name) \
 	struct wait_queue_head name = __WAIT_QUEUE_HEAD_INIT_ONSTACK(name)
+#endif
 #else
 # define DECLARE_WAIT_QUEUE_HEAD_ONSTACK(name) DECLARE_WAIT_QUEUE_HEAD(name)
 #endif
diff --git a/kernel/kthread.c b/kernel/kthread.c
index aaa355dcbd17..f69a10e300e8 100644
--- a/kernel/kthread.c
+++ b/kernel/kthread.c
@@ -918,10 +918,13 @@ static void kthread_flush_work_fn(struct kthread_work *work)
  */
 void kthread_flush_work(struct kthread_work *work)
 {
+#pragma GCC diagnostic push
+#pragma GCC diagnostic ignored "-Wuninitialized"
 	struct kthread_flush_work fwork = {
 		KTHREAD_WORK_INIT(fwork.work, kthread_flush_work_fn),
 		COMPLETION_INITIALIZER_ONSTACK(fwork.done),
 	};
+#pragma GCC diagnostic pop
 	struct kthread_worker *worker;
 	bool noop = false;
 
@@ -1125,10 +1128,13 @@ EXPORT_SYMBOL_GPL(kthread_cancel_delayed_work_sync);
  */
 void kthread_flush_worker(struct kthread_worker *worker)
 {
+#pragma GCC diagnostic push
+#pragma GCC diagnostic ignored "-Wuninitialized"
 	struct kthread_flush_work fwork = {
 		KTHREAD_WORK_INIT(fwork.work, kthread_flush_work_fn),
 		COMPLETION_INITIALIZER_ONSTACK(fwork.done),
 	};
+#pragma GCC diagnostic pop
 
 	kthread_queue_work(worker, &fwork.work);
 	wait_for_completion(&fwork.done);
diff --git a/kernel/smp.c b/kernel/smp.c
index 3061483cb3ad..a8c011edadae 100644
--- a/kernel/smp.c
+++ b/kernel/smp.c
@@ -775,12 +775,15 @@ static void smp_call_on_cpu_callback(struct work_struct *work)
 
 int smp_call_on_cpu(unsigned int cpu, int (*func)(void *), void *par, bool phys)
 {
+#pragma GCC diagnostic push
+#pragma GCC diagnostic ignored "-Wuninitialized"
 	struct smp_call_on_cpu_struct sscs = {
 		.done = COMPLETION_INITIALIZER_ONSTACK(sscs.done),
 		.func = func,
 		.data = par,
 		.cpu  = phys ? cpu : -1,
 	};
+#pragma GCC diagnostic pop
 
 	INIT_WORK_ONSTACK(&sscs.work, smp_call_on_cpu_callback);
 
diff --git a/kernel/workqueue.c b/kernel/workqueue.c
index a86688fabc55..d24b9fba8e7f 100644
--- a/kernel/workqueue.c
+++ b/kernel/workqueue.c
@@ -2577,11 +2577,14 @@ static bool flush_workqueue_prep_pwqs(struct workqueue_struct *wq,
  */
 void flush_workqueue(struct workqueue_struct *wq)
 {
+#pragma GCC diagnostic push
+#pragma GCC diagnostic ignored "-Wuninitialized"
 	struct wq_flusher this_flusher = {
 		.list = LIST_HEAD_INIT(this_flusher.list),
 		.flush_color = -1,
 		.done = COMPLETION_INITIALIZER_ONSTACK(this_flusher.done),
 	};
+#pragma GCC diagnostic pop
 	int next_color;
 
 	if (WARN_ON(!wq_online))
-- 
