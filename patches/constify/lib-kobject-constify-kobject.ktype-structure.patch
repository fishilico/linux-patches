From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Nicolas Iooss <nicolas.iooss_linux@m4x.org>
Date: Fri, 16 Sep 2016 22:34:22 +0200
Subject: [PATCH] {CONSTIFY} lib/kobject: constify kobject.ktype structure
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

NB: when upstreaming, split in 2 patches: make get_ktype() const and
ktype and helper functions const

grsecurity kernels warns:

    drivers/firmware/memmap.c: In function ‘firmware_map_add_entry’:
    drivers/firmware/memmap.c:160:29: error: passing argument 2 of
    ‘kobject_init’ discards ‘const’ qualifier from pointer target type
    [-Werror=discarded-qualifiers]
      kobject_init(&entry->kobj, &memmap_ktype);
                                 ^
    In file included from include/linux/module.h:17:0,
                     from drivers/firmware/memmap.c:20:
    include/linux/kobject.h:92:13: note: expected ‘struct kobj_type *’
    but argument is of type ‘const struct kobj_type *’
     extern void kobject_init(struct kobject *kobj, struct kobj_type *ktype);
                 ^~~~~~~~~~~~

    drivers/firmware/efi/runtime-map.c: In function ‘add_sysfs_runtime_map_entry’:
    drivers/firmware/efi/runtime-map.c:130:29: error: passing argument 2
    of ‘kobject_init’ discards ‘const’ qualifier from pointer target
    type [-Werror=discarded-qualifiers]
      kobject_init(&entry->kobj, &map_ktype);
                                 ^
    In file included from include/linux/module.h:17:0,
                     from drivers/firmware/efi/runtime-map.c:10:
    include/linux/kobject.h:92:13: note: expected ‘struct kobj_type *’
    but argument is of type ‘const struct kobj_type *’
     extern void kobject_init(struct kobject *kobj, struct kobj_type *ktype);
                 ^~~~~~~~~~~~
---
 include/linux/module.h | 2 +-
 kernel/params.c        | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/include/linux/module.h b/include/linux/module.h
index 4435ad9439ab..955ae6cb43b3 100644
--- a/include/linux/module.h
+++ b/include/linux/module.h
@@ -834,7 +834,7 @@ void *dereference_module_function_descriptor(struct module *mod, void *ptr)
 
 #ifdef CONFIG_SYSFS
 extern struct kset *module_kset;
-extern struct kobj_type module_ktype;
+extern const struct kobj_type module_ktype;
 #endif /* CONFIG_SYSFS */
 
 #define symbol_request(x) try_then_request_module(symbol_get(x), "symbol:" #x)
diff --git a/kernel/params.c b/kernel/params.c
index 6e34ca89ebae..6a7548979aa9 100644
--- a/kernel/params.c
+++ b/kernel/params.c
@@ -948,7 +948,7 @@ static void module_kobj_release(struct kobject *kobj)
 	complete(mk->kobj_completion);
 }
 
-struct kobj_type module_ktype = {
+const struct kobj_type module_ktype = {
 	.release   =	module_kobj_release,
 	.sysfs_ops =	&module_sysfs_ops,
 };
-- 
